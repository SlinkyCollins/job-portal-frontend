<div class="container py-4">
    <h5 class="card-title fw-bold">My Resume</h5>
    <form [formGroup]="resumeForm">
        <!-- Resume Attachment -->
        <div class="card mb-4">
            <div class="card-body">
                <h6 class="fw-bold">Resume Attachment</h6>
                <div class="row g-3 align-items-center">
                    <div class="col-md-6">
                        <label class="form-label">CV Attachment*</label>
                        <div *ngIf="!uploadedCV">
                            <label for="cvUpload" class="btn btn-outline-primary w-100" [class.disabled]="isUploading">
                                {{ isUploading ? 'Uploading...' : 'Upload CV' }}
                                <i *ngIf="!isUploading" class="bi bi-file-earmark-arrow-up ms-2"></i>
                                <i *ngIf="isUploading" class="fas fa-spinner fa-spin ms-2"></i>
                            </label>
                            <input type="file" id="cvUpload" hidden (change)="onFileSelected($event)"
                                accept=".pdf,.doc,.docx" [disabled]="isUploading || isDeleting">
                            <small class="form-text text-muted">Upload your CV in PDF or Word format.</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <!-- Progress Bar -->
                        <div *ngIf="isUploading" class="mt-2">
                            <div class="progress">
                                <div class="progress-bar" [style.width.%]="uploadProgress"></div>
                            </div>
                            <small>{{ uploadProgress }}% uploaded</small>
                        </div>
                        <!-- Uploaded CV Display -->
                        <div *ngIf="uploadedCV && !isUploading" class="mt-2">
                            <span class="badge bg-success">{{ selectedFileName }}</span>
                            <button type="button" class="btn btn-sm btn-outline-danger ms-2" [disabled]="isDeleting"
                                (click)="openDeleteModal()">
                                {{ isDeleting ? 'Deleting...' : 'Delete' }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Intro & Overview -->
        <div class="card mb-4">
            <div class="card-body">
                <h6 class="fw-bold">Intro & Overview</h6>

                <div class="mb-3">
                    <label class="form-label">Overview*</label>
                    <textarea class="form-control" rows="3" formControlName="overview"
                        placeholder="Tell us about your experience and background"
                        [class.is-valid]="resumeForm.get('overview')?.valid && resumeForm.get('overview')?.touched"
                        [class.is-invalid]="resumeForm.get('overview')?.invalid && (resumeForm.get('overview')?.touched || resumeForm.get('overview')?.dirty)"
                        required></textarea>
                </div>
                <div
                    *ngIf="resumeForm.get('overview')?.invalid && (resumeForm.get('overview')?.touched || resumeForm.get('overview')?.dirty)">
                    <span class="text-danger" *ngIf="resumeForm.get('overview')?.getError('maxlength')">This field must
                        not be
                        more
                        than 500 characters</span>
                    <span class="text-danger" *ngIf="resumeForm.get('overview')?.getError('required')">This field is
                        required</span>
                </div>
                <span>Brief description for your resume. URLs are hyperlinked.</span>
            </div>
        </div>

        <!-- Education -->
        <div class="card mb-4">
            <div class="card-body">
                <h6 class="fw-bold">Education</h6>

                <div formArrayName="education">
                    <div *ngFor="let edu of education.controls; let i = index" [formGroupName]="i"
                        class="mb-3 border p-3 rounded">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">School Name</label>
                                <input type="text" class="form-control" formControlName="school"
                                    placeholder="University of Lagos">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Field of Study</label>
                                <input type="text" class="form-control" formControlName="field"
                                    placeholder="Computer Engineering">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Start Year</label>
                                <input type="text" class="form-control" formControlName="startYear" placeholder="2018">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">End Year</label>
                                <input type="text" class="form-control" formControlName="endYear" placeholder="2023">
                            </div>

                            <div class="col-12">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" rows="2" formControlName="description"
                                    placeholder="Write what you studied, projects etc..."></textarea>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger mt-2"
                            (click)="removeEducation(i)">Remove</button>
                    </div>
                </div>

                <!-- Error message for at least one education -->
                <div *ngIf="education.hasError('atLeastOne') && (education.touched || education.dirty)">
                    <span class="text-danger">At least one education entry is required.</span>
                </div>

                <button type="button" class="btn btn-outline-secondary btn-sm mt-3" (click)="addEducation()">+ Add
                    Education</button>
            </div>
        </div>

        <!-- Skills & Experience -->
        <div class="card mb-4">
            <div class="card-body">
                <h6 class="fw-bold">Skills & Experience</h6>

                <div class="mb-3">
                    <label class="form-label">Skills</label>
                    <div class="d-flex flex-wrap gap-2">
                        <span *ngFor="let skill of skills.controls; let i = index"
                            class="badge bg-light border text-dark">
                            {{ skill.value }} <i class="fas fa-times ms-1" (click)="removeSkill(i)" style="cursor: pointer;"></i>
                        </span>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Add New Skill</label>
                    <input type="text" id="newSkill" class="form-control" placeholder="e.g. TypeScript"
                        [class.is-valid]="resumeForm.get('skills')?.valid && resumeForm.get('skills')?.touched"
                        [class.is-invalid]="resumeForm.get('skills')?.invalid && (resumeForm.get('skills')?.touched || resumeForm.get('skills')?.dirty)">
                    <div
                        *ngIf="resumeForm.get('skills')?.invalid && (resumeForm.get('skills')?.touched || resumeForm.get('skills')?.dirty)">
                        <span class="text-danger" *ngIf="resumeForm.get('skills')?.hasError('atLeastOne')">At least one
                            skill is required.</span>
                    </div>
                </div>

                <button type="button" class="btn btn-outline-secondary btn-sm" (click)="addSkill()">+ Add Skill</button>

                <div class="mb-3 mt-3">
                    <label class="form-label">Experience</label>
                    <textarea class="form-control" rows="3" formControlName="experience"
                        placeholder="Describe your work experience..."
                        [class.is-valid]="resumeForm.get('experience')?.valid && resumeForm.get('experience')?.touched"
                        [class.is-invalid]="resumeForm.get('experience')?.invalid && (resumeForm.get('experience')?.touched || resumeForm.get('experience')?.dirty)"
                        required></textarea>
                    <div
                        *ngIf="resumeForm.get('experience')?.invalid && (resumeForm.get('experience')?.touched || resumeForm.get('experience')?.dirty)">
                        <span class="text-danger" *ngIf="resumeForm.get('experience')?.getError('maxlength')">This field
                            must
                            not be
                            more
                            than 1000 characters</span>
                        <span class="text-danger" *ngIf="resumeForm.get('experience')?.getError('required')">This field
                            is
                            required</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio (DEFERRED AFTER MVP) -->
        <!-- <div class="card mb-4">
            <div class="card-body">
                <h6 class="fw-bold">Portfolio</h6>

                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="border rounded p-3 text-center">
                            <img src="https://via.placeholder.com/150" class="img-fluid mb-2" alt="Portfolio Item">
                            <p class="mb-0">Project Title</p>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="border rounded p-3 text-center">
                            <img src="https://via.placeholder.com/150" class="img-fluid mb-2" alt="Portfolio Item">
                            <p class="mb-0">Project Title</p>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn btn-outline-secondary btn-sm mt-3">+ Add More</button>
            </div>
        </div> -->

        <!-- Buttons -->
        <div class="d-flex justify-content-start">
            <button type="submit" class="btn btn-success me-2"
                [disabled]="isSaving || !resumeForm.dirty" (click)="onSubmit()">{{ isSaving ?
                'Saving...' : 'Save' }}</button>
            <button type="button" class="btn btn-outline-secondary" [disabled]="isSaving || !resumeForm.dirty"
                (click)="onReset()">Cancel</button>
        </div>
    </form>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" [class.active]="showDeleteModal" (click)="closeDeleteModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>Confirm Delete</h3>
            <button class="modal-close-btn" (click)="closeDeleteModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="delete-icon">
                <i class="fas fa-trash"></i>
            </div>
            <p>Are you sure you want to delete your CV?</p>
            <p class="modal-subtitle">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" (click)="closeDeleteModal()" [disabled]="isDeleting">Cancel</button>
            <button class="btn-confirm" (click)="confirmDelete()" [disabled]="isDeleting">
                {{ isDeleting ? 'Deleting...' : 'Delete' }}
                <i *ngIf="isDeleting" class="fas fa-spinner fa-spin ms-2"></i>
            </button>
        </div>
    </div>
</div>