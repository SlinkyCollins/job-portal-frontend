<div class="container-fluid px-3 px-md-4 py-4">
  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="page-title">Account Settings</h2>
    </div>
  </div>

  <!-- Edit & Update Section -->
  <div class="row mb-5">
    <div class="col-12">
      <!-- Skeleton Loader -->
      <div class="settings-card" *ngIf="isLoading">
        <div class="skeleton skeleton-text mb-4" style="width: 150px; height: 28px;"></div>

        <!-- Name Fields Skeleton -->
        <div class="row mb-3">
          <div class="col-12 col-md-6 mb-3 mb-md-0">
            <div class="skeleton skeleton-text mb-2" style="width: 80px;"></div>
            <div class="skeleton skeleton-input"></div>
          </div>
          <div class="col-12 col-md-6">
            <div class="skeleton skeleton-text mb-2" style="width: 80px;"></div>
            <div class="skeleton skeleton-input"></div>
          </div>
        </div>

        <!-- Email Field Skeleton -->
        <div class="row mb-3">
          <div class="col-12">
            <div class="skeleton skeleton-text mb-2" style="width: 60px;"></div>
            <div class="skeleton skeleton-input"></div>
          </div>
        </div>

        <!-- Action Buttons Skeleton -->
        <div class="row">
          <div class="col-12">
            <div class="d-flex align-items-center gap-3">
              <div class="skeleton skeleton-btn"></div>
              <div class="skeleton skeleton-btn" style="width: 80px;"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="settings-card" *ngIf="!isLoading">
        <h4 class="section-title mb-4">Edit & Update</h4>

        <form [formGroup]="profileForm" (ngSubmit)="onSaveProfile()">
          <!-- Name Fields Row -->
          <div class="row mb-3">
            <div class="col-12 col-md-6 mb-3 mb-md-0">
              <label for="firstName" class="form-label">First Name</label>
              <input type="text" class="form-control custom-input" id="firstName" formControlName="firstName"
                placeholder="John Doe">
              <div *ngIf="profileForm.get('firstName')?.invalid && profileForm.get('firstName')?.touched"
                class="invalid-feedback d-block">
                First name is required
              </div>
              <div class="invalid-feedback d-block" *ngIf="profileForm.get('firstName')?.getError('minlength')">This
                field must not
                be
                less
                than 2 words</div>
            </div>
            <div class="col-12 col-md-6">
              <label for="lastName" class="form-label">Last Name</label>
              <input type="text" class="form-control custom-input" id="lastName" formControlName="lastName"
                placeholder="Kabir">
              <div *ngIf="profileForm.get('lastName')?.invalid && profileForm.get('lastName')?.touched"
                class="invalid-feedback d-block">
                Last name is required
              </div>
              <div class="invalid-feedback d-block" *ngIf="profileForm.get('lastName')?.getError('minlength')">This
                field must not
                be
                less
                than 2 words</div>
            </div>
          </div>

          <!-- Email Field -->
          <div class="row mb-3">
            <div class="col-12">
              <label for="email" class="form-label">Email Address</label>

              <!-- Added bg-light to make it look read-only visually -->
              <input type="email" class="form-control custom-input bg-light" id="email" formControlName="email"
                placeholder="johndoe@example.com" readonly>

              <!-- Universal Helper Text -->
              <div class="form-text text-muted">
                <i class="fas fa-lock me-1"></i> To change your email address, please contact support.
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="row">
            <div class="col-12">
              <div class="d-flex align-items-center gap-3">
                <button type="submit" class="btn btn-save"
                  [disabled]="profileForm.invalid || isProfileSaving || !profileForm.dirty">
                  <span *ngIf="isProfileSaving" class="spinner-border spinner-border-sm me-2" role="status"></span>
                  {{ isProfileSaving ? 'Saving...' : 'Save' }}
                </button>
                <button type="button" class="btn btn-cancel" [disabled]="isProfileSaving || !profileForm.dirty"
                  (click)="onCancelProfile()">
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Social Buttons -->
  <div class="d-flex flex-wrap gap-2 mb-1">
    <button type="button" *ngIf="showLinkFacebook" class="btn btn-outline-secondary btn-sm" (click)="linkFacebook()"
      [disabled]="isLinkingFacebook || isFacebookLinked">
      <img
        src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/51/Facebook_f_logo_%282019%29.svg/32px-Facebook_f_logo_%282019%29.svg.png"
        alt="Facebook" width="20" height="20" class="me-2" *ngIf="!isLinkingFacebook">
      <span *ngIf="isLinkingFacebook" class="spinner-border spinner-border-sm me-1"></span>
      {{ isLinkingFacebook ? 'Linking...' : (isFacebookLinked ? 'Facebook Linked' : 'Link Facebook Account') }}
    </button>

    <button type="button" *ngIf="showLinkGoogle" class="btn btn-outline-secondary btn-sm" (click)="linkGoogle()"
      [disabled]="isLinkingGoogle || isGoogleLinked">
      <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Google" width="20"
        height="20" class="me-2" *ngIf="!isLinkingGoogle">
      <span *ngIf="isLinkingGoogle" class="spinner-border spinner-border-sm me-1"></span>
      {{ isLinkingGoogle ? 'Linking...' : (isGoogleLinked ? 'Google Linked' : 'Link Google Account') }}
    </button>
  </div>

  <!-- Linked Providers Section -->
  <div class="mb-4" *ngIf="linkedProviders.length > 0; else noProviders">
    <h6 class="fw-bold mb-3">Linked Accounts</h6>

    <div class="d-flex flex-wrap gap-3">
      <div *ngFor="let provider of linkedProviders" class="connected-account-pill">

        <!-- Google Icon -->
        <img *ngIf="provider.includes('google')"
          src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Google" width="20"
          height="20">

        <!-- Facebook Icon -->
        <img *ngIf="provider.includes('facebook')"
          src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/51/Facebook_f_logo_%282019%29.svg/32px-Facebook_f_logo_%282019%29.svg.png"
          alt="Facebook" width="20" height="20">

        <!-- Provider Name -->
        <span class="ms-2 fw-semibold text-dark">
          {{ provider.includes('google') ? 'Google' : (provider.includes('facebook') ? 'Facebook' : provider) }}
        </span>

        <!-- Status Badge -->
        <span class="ms-2 badge bg-success-subtle text-success border border-success-subtle rounded-pill w-100"
          style="font-size: 0.65rem; padding: 0.35em 0.65em;">
          <i class="fas fa-check me-1"></i>Connected
        </span>
      </div>

    </div>
  </div>
  <ng-template #noProviders>
    <p class="text-muted">No linked accounts found.</p>
  </ng-template>

  <!-- Change Password Section -->
  <div class="row" *ngIf="!isLoading && !isSocialLogin">
    <div class="col-12">
      <h2 class="page-title">Change Password</h2>
      <div class="settings-card">

        <form [formGroup]="passwordForm" (ngSubmit)="onChangePassword()">
          <!-- Old Password -->
          <div class="row mb-3">
            <div class="col-12">
              <label for="oldPassword" class="form-label">Old Password*</label>
              <div class="password-input-container">
                <input [type]="showOldPassword ? 'text' : 'password'" class="form-control custom-input" id="oldPassword"
                  formControlName="oldPassword" placeholder="">
                <button type="button" class="password-toggle-btn" (click)="toggleOldPassword()"
                  [attr.aria-label]="showOldPassword ? 'Hide password' : 'Show password'">
                  <i [class]="showOldPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                </button>
              </div>
              <button *ngIf="!oldPasswordVerified" type="button" class="btn btn-save mt-4" (click)="verifyOldPassword()"
                [disabled]="!passwordForm.get('oldPassword')?.value || isVerifyingOldPassword">
                {{ isVerifyingOldPassword ? 'Verifying...' : 'Verify Old Password' }}
              </button>
              <div
                *ngIf="!oldPasswordVerified && passwordForm.get('oldPassword')?.invalid && passwordForm.get('oldPassword')?.touched"
                class="text-danger mt-1">
                Please verify your old password.
              </div>
              <div *ngIf="passwordForm.get('oldPassword')?.invalid && passwordForm.get('oldPassword')?.touched"
                class="invalid-feedback d-block">
                Current password is required
              </div>
            </div>
          </div>

          <!-- New Password -->
          <div class="row mb-3" *ngIf="oldPasswordVerified">
            <div class="col-12">
              <label for="newPassword" class="form-label">New Password*</label>
              <div class="password-input-container">
                <input [type]="showNewPassword ? 'text' : 'password'" class="form-control custom-input" id="newPassword"
                  formControlName="newPassword" placeholder="">
                <button type="button" class="password-toggle-btn" (click)="toggleNewPassword()"
                  [attr.aria-label]="showNewPassword ? 'Hide password' : 'Show password'">
                  <i [class]="showNewPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                </button>
              </div>
              <div *ngIf="passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched"
                class="invalid-feedback d-block">
                <span *ngIf="passwordForm.get('newPassword')?.errors?.['required']">New password is required</span>
                <span *ngIf="passwordForm.get('newPassword')?.errors?.['minlength']">Password must be at least 8
                  characters</span>
              </div>
              <div *ngIf="passwordForm.get('newPassword')?.errors?.['sameAsOld']" class="invalid-feedback d-block">
                New password cannot be the same as old password.
              </div>
            </div>
          </div>

          <!-- Confirm Password -->
          <div class="row mb-4" *ngIf="oldPasswordVerified">
            <div class="col-12">
              <label for="confirmPassword" class="form-label">Confirm Password*</label>
              <div class="password-input-container">
                <input [type]="showConfirmPassword ? 'text' : 'password'" class="form-control custom-input"
                  id="confirmPassword" formControlName="confirmPassword" placeholder="">
                <button type="button" class="password-toggle-btn" (click)="toggleConfirmPassword()"
                  [attr.aria-label]="showConfirmPassword ? 'Hide password' : 'Show password'">
                  <i [class]="showConfirmPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                </button>
              </div>
              <div *ngIf="passwordForm.get('confirmPassword')?.invalid && passwordForm.get('confirmPassword')?.touched"
                class="invalid-feedback d-block">
                <span *ngIf="passwordForm.get('confirmPassword')?.errors?.['required']">Please confirm your
                  password</span>
                <span *ngIf="passwordForm.get('confirmPassword')?.errors?.['passwordMismatch']">Passwords do not
                  match</span>
              </div>
            </div>
          </div>

          <!-- Action Button -->
          <div class="row" *ngIf="oldPasswordVerified">
            <div class="col-12">
              <button type="submit" class="btn btn-save" [disabled]="passwordForm.invalid || isPasswordSaving">
                <span *ngIf="isPasswordSaving" class="spinner-border spinner-border-sm me-2" role="status"></span>
                {{ isPasswordSaving ? 'Updating...' : 'Save & Update' }}
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Danger Zone Section -->
  <div class="row mt-5" *ngIf="!isLoading">
    <div class="col-12">
      <div class="settings-card border-danger" style="border-left: 5px solid #dc3545;">
        <h4 class="section-title text-danger mb-3">Danger Zone</h4>
        <p class="text-muted mb-4">Once you delete your account, there is no going back. Please be certain.</p>
        <button id="deleteAccountBtn" class="btn btn-outline-danger" (click)="openDeleteModal()">
          <i class="fas fa-trash me-2"></i>Delete Account
        </button>
      </div>
    </div>
  </div>

  <!-- Delete Account Modal -->
  <div class="modal-overlay" [class.active]="showDeleteModal" (click)="closeDeleteModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 class="text-danger">Delete Account</h3>
        <button class="modal-close-btn" (click)="closeDeleteModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning d-flex align-items-start mb-3">
          <i class="fas fa-exclamation-triangle me-2 mt-1"></i>
          <div>
            <strong>Warning:</strong> This action is permanent and cannot be undone. All your data, including profile
            information, resume, and job applications, will be permanently deleted.
          </div>
        </div>

        <div class="mb-3">
          <label for="deleteConfirmation" class="form-label">To confirm, type "DELETE" below:</label>
          <input type="text" class="form-control" id="deleteConfirmation" [value]="deleteConfirmationText"
            (input)="onDeleteInputChange($event)" placeholder="DELETE">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeDeleteModal()">Cancel</button>
        <button class="btn btn-danger" [disabled]="deleteConfirmationText !== 'DELETE' || isDeletingAccount"
          (click)="handleAccountDeletion()">
          <span *ngIf="isDeletingAccount" class="spinner-border spinner-border-sm me-2" role="status"
            aria-hidden="true"></span>
          {{ isDeletingAccount ? 'Deleting...' : 'Delete Account' }}
        </button>
      </div>
    </div>
  </div>
</div>