<div class="post-job-container fade-in">

    <div class="page-header mb-4">
        <div>
            <h1 class="h3 mb-1">{{ isEditMode ? 'Edit Job' : 'Post a New Job' }}</h1>
            <p class="text-muted">{{ isEditMode ? 'Update your job details' : 'Find the best talent for your company' }}
            </p>
        </div>
    </div>

    <form [formGroup]="jobForm" (ngSubmit)="onSubmit()" *ngIf="!isLoading || !isEditMode">

        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white py-3 theme-card-header">
                <h5 class="mb-0 theme-text"><i class="fas fa-info-circle me-2"></i>Basic Information</h5>
            </div>
            <div class="card-body">
                <div class="row g-5">

                    <div class="col-md-12">
                        <label class="form-label required">Job Title</label>
                        <input type="text" class="form-control" formControlName="title"
                            placeholder="e.g. Senior Frontend Developer">
                        <div *ngIf="jobForm.get('title')?.touched && jobForm.get('title')?.invalid"
                            class="text-danger small mt-1">
                            Title is required (min 5 chars).
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label required">Category</label>
                        <select class="form-select" formControlName="category_id" [compareWith]="compareFn">
                            <option [ngValue]="null" disabled>Select Category</option>

                            <option *ngFor="let cat of categories" [ngValue]="cat.id">
                                {{ cat.name }}
                            </option>
                        </select>

                        <div *ngIf="jobForm.get('category_id')?.touched && jobForm.get('category_id')?.invalid"
                            class="text-danger small mt-1">
                            Category is required.
                        </div>
                    </div>

                    <div class="col-12 mb-3">
                        <label class="form-label">Job Tags <span class="text-muted small">(Skills, Tools,
                                Keywords)</span></label>

                        <div class="form-control d-flex flex-wrap align-items-center gap-2"
                            style="min-height: 48px; height: auto; padding: 6px 12px;">

                            <span *ngFor="let tag of tags; let i = index"
                                class="badge tag-pill rounded-pill d-flex align-items-center px-3 py-2">
                                {{ tag }}
                                <i class="fas fa-times ms-2 cursor-pointer" (click)="removeTag(i)"
                                    style="cursor: pointer; font-size: 0.8em;"></i>
                            </span>

                            <input type="text" class="border-0 bg-transparent flex-grow-1"
                                style="outline: none; min-width: 150px;" placeholder="Type & press Enter..."
                                (keydown.enter)="$event.preventDefault(); addTag($event)" (input)="onTagInput($event)">
                        </div>

                        <div class="mt-2" *ngIf="filteredTags.length > 0">
                            <small class="text-muted d-block mb-2">Suggested Skills:</small>
                            <div class="d-flex flex-wrap gap-2">
                                <button type="button"
                                    *ngFor="let tag of filteredTags | slice:0:(showAllTags ? filteredTags.length : 10)"
                                    (click)="selectSuggestion(tag.name)"
                                    class="btn btn-sm suggestion-btn border rounded-pill transition-all">
                                    {{ tag.name }} <i class="fas fa-plus ms-1 text-muted" style="font-size: 0.7em;"></i>
                                </button>

                                <button type="button" *ngIf="filteredTags.length > 10"
                                    (click)="showAllTags = !showAllTags"
                                    class="btn btn-sm btn-link text-decoration-none theme-link">
                                    {{ showAllTags ? 'Show Less' : '+' + (filteredTags.length - 10) + ' More' }}
                                </button>
                            </div>
                        </div>

                        <div class="form-text mt-1" *ngIf="filteredTags.length === 0">
                            Type and press Enter to create a new custom tag.
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label required">Employment Type</label>
                        <select class="form-select" formControlName="employment_type">
                            <option *ngFor="let type of employmentTypes" [value]="type">{{ type | uppercase }}</option>
                        </select>
                    </div>

                    <div class="col-md-12">
                        <label class="form-label required">Location</label>
                        <input type="text" class="form-control" formControlName="location"
                            placeholder="e.g. Lagos, Nigeria or Remote">
                        <div *ngIf="jobForm.get('location')?.touched && jobForm.get('location')?.invalid"
                            class="text-danger small mt-1">
                            Location is required.
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white py-3 theme-card-header">
                <h5 class="mb-0 theme-text"><i class="fas fa-align-left me-2"></i>Job Details</h5>
            </div>
            <div class="card-body">
                <div class="row g-5">

                    <div class="col-12">
                        <label class="form-label required">Job Overview</label>
                        <textarea class="form-control" rows="3" formControlName="overview"
                            placeholder="Brief summary of the role (min 50 chars)"></textarea>
                        <div *ngIf="jobForm.get('overview')?.touched && jobForm.get('overview')?.invalid"
                            class="text-danger small mt-1">
                            Overview is required (min 50 chars).
                        </div>
                    </div>

                    <div class="col-12">
                        <label class="form-label required">Full Description</label>
                        <textarea class="form-control" rows="6" formControlName="description"
                            placeholder="Detailed description of the role..."></textarea>
                        <div *ngIf="jobForm.get('description')?.touched && jobForm.get('description')?.invalid"
                            class="text-danger small mt-1">
                            Description is required (min 100 chars).
                        </div>
                    </div>

                    <div class="col-12">
                        <label class="form-label required">Key Responsibilities</label>
                        <textarea class="form-control" rows="4" formControlName="responsibilities"
                            placeholder="- Lead the development team&#10;- Architect scalable solutions..."></textarea>
                        <div *ngIf="jobForm.get('responsibilities')?.touched && jobForm.get('responsibilities')?.invalid"
                            class="text-danger small mt-1">
                            Responsibilities are required.
                        </div>
                        <div *ngIf="previewResponsibilities.length > 0" class="form-text mt-1">Tip: Write each
                            responsibility
                            on a new line for better formatting.</div>

                        <!-- Live Preview -->
                        <div *ngIf="previewResponsibilities.length > 0" class="mt-3">
                            <label class="form-label small text-muted">Preview (How it will appear):</label>
                            <ul class="list-unstyled border rounded p-3 bg-light">
                                <li *ngFor="let resp of previewResponsibilities" class="mb-1">
                                    <i class="fas fa-check text-success me-2"></i>{{ resp }}
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="col-12">
                        <label class="form-label required">Requirements / Skills</label>
                        <textarea class="form-control" rows="4" formControlName="requirements"
                            placeholder="- 5+ years experience with Angular&#10;- Strong knowledge of TypeScript..."></textarea>
                        <div *ngIf="jobForm.get('requirements')?.touched && jobForm.get('requirements')?.invalid"
                            class="text-danger small mt-1">
                            Requirements are required.
                        </div>
                        <div *ngIf="previewRequirements.length > 0" class="form-text mt-1">Tip: Write each requirement
                            on a new line for better formatting.</div>

                        <!-- Live Preview -->
                        <div *ngIf="previewRequirements.length > 0" class="mt-3">
                            <label class="form-label small text-muted">Preview (How it will appear):</label>
                            <ul class="list-unstyled border rounded p-3 bg-light">
                                <li *ngFor="let req of previewRequirements" class="mb-1">
                                    <i class="fas fa-check text-success me-2"></i>{{ req }}
                                </li>
                            </ul>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white py-3 theme-card-header">
                <h5 class="mb-0 theme-text"><i class="fas fa-money-bill-wave me-2"></i>Salary & Benefits</h5>
            </div>
            <div class="card-body">
                <div class="row g-5">

                    <div class="col-md-3">
                        <label class="form-label">Currency</label>
                        <select class="form-select" formControlName="currency">
                            <option *ngFor="let curr of currencies" [value]="curr">{{ curr }}</option>
                        </select>
                    </div>

                    <div class="col-md-5">
                        <label class="form-label required">Salary Amount</label>

                        <input type="text" class="form-control" formControlName="salary_amount"
                            placeholder="e.g. 250,000 (Min Budget)" (input)="formatSalary($event)">

                        <div *ngIf="jobForm.get('salary_amount')?.touched && jobForm.get('salary_amount')?.invalid"
                            class="text-danger small mt-1">

                            <div *ngIf="jobForm.get('salary_amount')?.hasError('required')">
                                Salary is required.
                            </div>

                            <div *ngIf="jobForm.get('salary_amount')?.hasError('min')">
                                Salary cannot be 0 or negative.
                            </div>

                            <div *ngIf="jobForm.get('salary_amount')?.hasError('max')">
                                Salary is too high (Max: 99,999,999).
                            </div>

                            <div *ngIf="jobForm.get('salary_amount')?.hasError('invalidNumber')">
                                Please enter a valid number.
                            </div>

                        </div>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Per</label>
                        <select class="form-select" formControlName="salary_duration">
                            <option *ngFor="let dur of salaryDurations" [value]="dur">{{ dur }}</option>
                        </select>
                    </div>

                    <div class="col-12">
                        <label class="form-label">Benefits & Perks</label>
                        <textarea class="form-control" rows="3" formControlName="benefits"
                            placeholder="- Health Insurance&#10;- Remote Work Options..."></textarea>
                        <div *ngIf="previewBenefits.length > 0" class="form-text mt-1">Tip: Write each benefit
                            on a new line for better formatting.</div>

                        <!-- Live Preview -->
                        <div *ngIf="previewBenefits.length > 0" class="mt-3">
                            <label class="form-label small text-muted">Preview (How it will appear):</label>
                            <ul class="list-unstyled border rounded p-3 bg-light">
                                <li *ngFor="let ben of previewBenefits" class="mb-1">
                                    <i class="fas fa-check text-success me-2"></i>{{ ben }}
                                </li>
                            </ul>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white py-3 theme-card-header">
                <h5 class="mb-0 theme-text"><i class="fas fa-user-check me-2"></i>Candidate Preferences</h5>
            </div>
            <div class="card-body">
                <div class="row g-5">

                    <div class="col-md-4">
                        <label class="form-label required">Experience Level</label>
                        <select class="form-select" formControlName="experience_level">
                            <option *ngFor="let level of experienceLevels" [value]="level">{{ level }}</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">English Fluency</label>
                        <select class="form-select" formControlName="english_fluency">
                            <option *ngFor="let level of englishLevels" [value]="level">{{ level }}</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Application Deadline</label>
                        <input type="date" class="form-control" formControlName="deadline" [min]="minDate">
                        <div class="form-text">Leave blank for default (30 days).</div>
                    </div>

                    <div class="col-12">
                        <label class="form-label">Nice to Have (Optional)</label>
                        <textarea class="form-control" rows="3" formControlName="nice_to_have"
                            placeholder="Additional skills that are a plus..."></textarea>
                        <div *ngIf="previewNiceToHave.length > 0" class="form-text mt-1">Tip: Write each nice-to-have
                            on a new line for better formatting.</div>

                        <!-- Live Preview -->
                        <div *ngIf="previewNiceToHave.length > 0" class="mt-3">
                            <label class="form-label small text-muted">Preview (How it will appear):</label>
                            <ul class="list-unstyled border rounded p-3 bg-light">
                                <li *ngFor="let nice of previewNiceToHave" class="mb-1">
                                    <i class="fas fa-check text-success me-2"></i>{{ nice }}
                                </li>
                            </ul>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="d-flex flex-column flex-md-row gap-2 justify-content-between justify-content-md-end mb-5 mx-3">
            <button type="button" class="btn btn-cancel w-100" (click)="onReset()">
                Cancel
            </button>
            <button type="submit" class="btn btn-theme w-100"
                [disabled]="isSubmitting || jobForm.invalid || !jobForm.dirty">
                <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2" role="status"
                    aria-hidden="true"></span>
                {{ isSubmitting ? 'Processing...' : (isEditMode ? 'Update Job' : 'Next') }}
            </button>
        </div>

    </form>

    <!-- Skeleton Loader for Edit Mode -->
    <div *ngIf="isLoading && isEditMode" class="skeleton-container">
        <!-- Basic Information Skeleton -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white py-3 theme-card-header">
                <div class="skeleton skeleton-header"></div>
            </div>
            <div class="card-body">
                <div class="row g-5">
                    <div class="col-md-12">
                        <div class="skeleton skeleton-text mb-2"></div>
                        <div class="skeleton skeleton-input"></div>
                    </div>
                    <div class="col-md-6">
                        <div class="skeleton skeleton-text mb-2"></div>
                        <div class="skeleton skeleton-input"></div>
                    </div>
                    <div class="col-md-6">
                        <div class="skeleton skeleton-text mb-2"></div>
                        <div class="skeleton skeleton-input"></div>
                    </div>
                    <div class="col-12">
                        <div class="skeleton skeleton-text mb-2"></div>
                        <div class="skeleton skeleton-input" style="min-height: 48px;"></div>
                    </div>
                    <div class="col-md-6">
                        <div class="skeleton skeleton-text mb-2"></div>
                        <div class="skeleton skeleton-input"></div>
                    </div>
                    <div class="col-md-12">
                        <div class="skeleton skeleton-text mb-2"></div>
                        <div class="skeleton skeleton-input"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Job Details Skeleton -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white py-3 theme-card-header">
                <div class="skeleton skeleton-header"></div>
            </div>
            <div class="card-body">
                <div class="row g-5">
                    <div class="col-12">
                        <div class="skeleton skeleton-text mb-2"></div>
                        <div class="skeleton skeleton-textarea"></div>
                    </div>
                    <div class="col-12">
                        <div class="skeleton skeleton-text mb-2"></div>
                        <div class="skeleton skeleton-textarea"></div>
                    </div>
                    <div class="col-12">
                        <div class="skeleton skeleton-text mb-2"></div>
                        <div class="skeleton skeleton-textarea"></div>
                    </div>
                    <div class="col-12">
                        <div class="skeleton skeleton-text mb-2"></div>
                        <div class="skeleton skeleton-textarea"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Salary & Benefits Skeleton -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white py-3 theme-card-header">
                <div class="skeleton skeleton-header"></div>
            </div>
            <div class="card-body">
                <div class="row g-5">
                    <div class="col-md-3">
                        <div class="skeleton skeleton-text mb-2"></div>
                        <div class="skeleton skeleton-input"></div>
                    </div>
                    <div class="col-md-5">
                        <div class="skeleton skeleton-text mb-2"></div>
                        <div class="skeleton skeleton-input"></div>
                    </div>
                    <div class="col-md-4">
                        <div class="skeleton skeleton-text mb-2"></div>
                        <div class="skeleton skeleton-input"></div>
                    </div>
                    <div class="col-12">
                        <div class="skeleton skeleton-text mb-2"></div>
                        <div class="skeleton skeleton-textarea"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Candidate Preferences Skeleton -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white py-3 theme-card-header">
                <div class="skeleton skeleton-header"></div>
            </div>
            <div class="card-body">
                <div class="row g-5">
                    <div class="col-md-4">
                        <div class="skeleton skeleton-text mb-2"></div>
                        <div class="skeleton skeleton-input"></div>
                    </div>
                    <div class="col-md-4">
                        <div class="skeleton skeleton-text mb-2"></div>
                        <div class="skeleton skeleton-input"></div>
                    </div>
                    <div class="col-md-4">
                        <div class="skeleton skeleton-text mb-2"></div>
                        <div class="skeleton skeleton-input"></div>
                    </div>
                    <div class="col-12">
                        <div class="skeleton skeleton-text mb-2"></div>
                        <div class="skeleton skeleton-textarea"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Buttons Skeleton -->
        <div class="d-flex flex-column flex-md-row gap-2 justify-content-between justify-content-md-end mb-5 mx-3">
            <div class="skeleton skeleton-button w-100"></div>
            <div class="skeleton skeleton-button w-100"></div>
        </div>
    </div>

    <!-- Cancel Confirmation Modal -->
    <div class="modal-overlay" [class.active]="showCancelConfirm" (click)="hideCancelModal()" role="dialog"
        aria-modal="true" aria-labelledby="cancelModalTitle">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3 id="cancelModalTitle">Confirm Cancel</h3>
                <button class="modal-close-btn" (click)="hideCancelModal()" aria-label="Close dialog">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="cancel-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <p>Are you sure you want to cancel?</p>
                <p class="modal-subtitle">Unsaved changes will be lost.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" (click)="hideCancelModal()">Keep Editing</button>
                <button class="btn-confirm" (click)="confirmCancel()">Cancel</button>
            </div>
        </div>
    </div>
</div>