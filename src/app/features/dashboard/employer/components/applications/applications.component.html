<div class="container-fluid fade-in">
    <h2 class="h3 mb-4">Candidate Applications</h2>

    <!-- Loading -->
    <div *ngIf="isLoading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!isLoading && applications.length === 0" class="text-center py-5 bg-white rounded shadow-sm">
        <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
        <h4>No Applications Yet</h4>
        <p class="text-muted">Once candidates apply to your jobs, they will appear here.</p>
    </div>

    <!-- List -->
    <div *ngIf="!isLoading && applications.length > 0" class="row">
        <div class="col-12" *ngFor="let app of applications">

            <div class="card mb-3 border-0 shadow-sm">
                <div class="card-body d-flex align-items-center flex-wrap gap-3">

                    <!-- Avatar -->
                    <img [src]="app.profile_pic_url || 'assets/images/default-avatar.png'" class="rounded-circle"
                        width="60" height="60" style="object-fit: cover;">

                    <!-- Info -->
                    <div class="flex-grow-1">
                        <h5 class="mb-1">{{ app.firstname }} {{ app.lastname }}</h5>
                        <p class="mb-1 text-muted small">
                            Applied for <span class="fw-bold text-dark">{{ app.job_title }}</span>
                        </p>
                        <div class="small text-muted">
                            <i class="fas fa-envelope me-1"></i> {{ app.email }}
                            <span class="mx-2">â€¢</span>
                            <i class="fas fa-clock me-1"></i> {{ app.applied_at | date:'mediumDate' }}
                        </div>
                    </div>

                    <!-- In your candidates table/card -->
                    <button class="btn btn-sm btn-outline-primary rounded-pill" (click)="openResumePreview(app.cv_url)">
                        <i class="fas fa-eye me-1"></i> Preview CV
                    </button>

                    <!-- Status Actions -->
                    <div class="dropdown">
                        <button class="btn btn-sm dropdown-toggle text-white" type="button" data-bs-toggle="dropdown"
                            [ngClass]="{
                            'btn-warning text-dark': app.status === 'pending',
                            'btn-info': app.status === 'shortlisted',
                            'btn-success': app.status === 'accepted',
                            'btn-danger': app.status === 'rejected'
                        }">
                            {{ app.status | titlecase }}
                        </button>

                        <ul class="dropdown-menu dropdown-menu-end">
                            <!-- Added Accepted Option -->
                            <li><a class="dropdown-item" (click)="updateStatus(app.application_id, 'accepted')">Accept
                                    (Hire)</a></li>
                            <li><a class="dropdown-item"
                                    (click)="updateStatus(app.application_id, 'shortlisted')">Shortlist</a></li>
                            <li><a class="dropdown-item"
                                    (click)="updateStatus(app.application_id, 'rejected')">Reject</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" (click)="updateStatus(app.application_id, 'pending')">Reset to
                                    Pending</a></li>
                        </ul>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>


<!-- PREVIEW MODAL OVERLAY -->
<div *ngIf="showPreviewModal" class="modal-backdrop fade show"></div>

<!-- PREVIEW MODAL -->
<div *ngIf="showPreviewModal" class="modal fade show d-block" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered" style="height: 90vh;">
        <div class="modal-content h-100">
            <div class="modal-header py-2">
                <h5 class="modal-title fs-6">Resume Preview</h5>
                <button type="button" class="btn-close" (click)="closePreview()"></button>
            </div>
            <div
                class="modal-body p-0 bg-light h-100 d-flex align-items-center justify-content-center position-relative">

              <!-- 1. PDF Viewer (Optimized for Viewing Only) -->
                <div *ngIf="previewFileType === 'pdf'" class="w-100 h-100">
                    <ngx-extended-pdf-viewer 
                        [src]="previewUrl" 
                        [height]="'90vh'"
                        
                        [showToolbar]="true" 
                        [showSidebarButton]="false" 
                        [showFindButton]="true"
                        [showPagingButtons]="true" 
                        [showZoomButtons]="true" 
                        [showPresentationModeButton]="true"
                        [showDownloadButton]="true" 
                        [showPrintButton]="true"
                        
                        [showTextEditor]="false"
                        [showDrawEditor]="false"
                        [showStampEditor]="false"
                        [showHandToolButton]="true">
                    </ngx-extended-pdf-viewer>
                </div>

                <!-- 2. DOC Viewer (Google Docs Iframe) -->
                <iframe *ngIf="previewFileType === 'doc'" [src]="previewUrl" class="w-100 h-100 border-0">
                </iframe>

            </div>
        </div>
    </div>
</div>