<app-navbar></app-navbar>
<div class="job-listing-container">
  <!-- Hero Section -->
  <div class="hero-section">
    <span class="lazy-img shape-1">
      <img src="/assets/img-11.svg" alt="shape" loading="lazy" decoding="async">
    </span>
    <span class="lazy-img shape-2">
      <img src="/assets/img-10.svg" alt="shape" loading="lazy" decoding="async">
    </span>
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-8 text-center" *ngIf="!isLoading && job">
          <p class="post-date">{{ job.published_at | relativeTime }}</p>
          <h1 class="hero-title">{{job.title}}</h1>
          <p class="hero-subtitle">Here is the job details & requirements</p>
        </div>
      </div>
    </div>
  </div>

  <div class="container py-5">
    <ng-container *ngIf="isLoading">
      <div class="row">
        <!-- Skeleton Main Content -->
        <div class="col-lg-8">
          <div class="job-content-card skeleton">

            <!-- Overview Section Skeleton -->
            <section class="content-section">
              <header class="section-header">
                <div class="section-icon skeleton-item"></div>
                <div class="skeleton-item" style="height: 1.5rem; width: 120px;"></div>
              </header>
              <div class="section-content">
                <div class="skeleton-item" style="height: 1rem; width: 100%; margin-bottom: 0.5rem;"></div>
                <div class="skeleton-item" style="height: 1rem; width: 85%; margin-bottom: 1rem;"></div>
                <div class="job-meta-tags">
                  <div class="skeleton-item meta-tag" style="height: 1.5rem; width: 80px;"></div>
                  <div class="skeleton-item meta-tag" style="height: 1.5rem; width: 100px;"></div>
                  <div class="skeleton-item meta-tag" style="height: 1.5rem; width: 90px;"></div>
                </div>
              </div>
            </section>

            <!-- Job Description Section Skeleton -->
            <section class="content-section">
              <header class="section-header">
                <div class="section-icon skeleton-item"></div>
                <div class="skeleton-item" style="height: 1.5rem; width: 140px;"></div>
              </header>
              <div class="section-content">
                <div class="skeleton-item" style="height: 1rem; width: 100%; margin-bottom: 0.5rem;"></div>
                <div class="skeleton-item" style="height: 1rem; width: 90%; margin-bottom: 0.5rem;"></div>
                <div class="skeleton-item" style="height: 1rem; width: 95%; margin-bottom: 0.5rem;"></div>
                <div class="skeleton-item" style="height: 1rem; width: 80%;"></div>
              </div>
            </section>

            <!-- Responsibilities Section Skeleton -->
            <section class="content-section">
              <header class="section-header">
                <div class="section-icon skeleton-item"></div>
                <div class="skeleton-item" style="height: 1.5rem; width: 130px;"></div>
              </header>
              <div class="section-content">
                <div class="skeleton-item" style="height: 1rem; width: 100%; margin-bottom: 0.5rem;"></div>
                <div class="skeleton-item" style="height: 1rem; width: 90%; margin-bottom: 0.5rem;"></div>
                <div class="skeleton-item" style="height: 1rem; width: 85%; margin-bottom: 0.5rem;"></div>
                <div class="skeleton-item" style="height: 1rem; width: 95%;"></div>
              </div>
            </section>

            <!-- Required Skills Section Skeleton -->
            <section class="content-section">
              <header class="section-header">
                <div class="section-icon skeleton-item"></div>
                <div class="skeleton-item" style="height: 1.5rem; width: 125px;"></div>
              </header>
              <div class="section-content">
                <div class="skeleton-item" style="height: 1rem; width: 100%; margin-bottom: 0.5rem;"></div>
                <div class="skeleton-item" style="height: 1rem; width: 80%; margin-bottom: 0.5rem;"></div>
                <div class="skeleton-item" style="height: 1rem; width: 90%;"></div>
              </div>
            </section>

            <!-- Nice to Have Section Skeleton -->
            <section class="content-section">
              <header class="section-header">
                <div class="section-icon skeleton-item"></div>
                <div class="skeleton-item" style="height: 1.5rem; width: 110px;"></div>
              </header>
              <div class="section-content">
                <div class="skeleton-item" style="height: 1rem; width: 100%; margin-bottom: 0.5rem;"></div>
                <div class="skeleton-item" style="height: 1rem; width: 85%; margin-bottom: 0.5rem;"></div>
                <div class="skeleton-item" style="height: 1rem; width: 95%;"></div>
              </div>
            </section>

            <!-- Benefits Section Skeleton -->
            <section class="content-section">
              <header class="section-header">
                <div class="section-icon skeleton-item"></div>
                <div class="skeleton-item" style="height: 1.5rem; width: 80px;"></div>
              </header>
              <div class="section-content">
                <div class="skeleton-item" style="height: 1rem; width: 100%; margin-bottom: 0.5rem;"></div>
                <div class="skeleton-item" style="height: 1rem; width: 90%; margin-bottom: 0.5rem;"></div>
                <div class="skeleton-item" style="height: 1rem; width: 80%; margin-bottom: 0.5rem;"></div>
                <div class="skeleton-item" style="height: 1rem; width: 95%;"></div>
              </div>
            </section>

          </div>
        </div>

        <!-- Skeleton Sidebar -->
        <div class="col-lg-4">
          <aside class="job-sidebar">

            <!-- Job Summary Card Skeleton -->
            <div class="sidebar-card skeleton">
              <div class="card-header">
                <div class="skeleton-item" style="height: 1.5rem; width: 120px;"></div>
              </div>
              <div class="card-body">
                <div class="info-item">
                  <div class="skeleton-item" style="height: 1rem; width: 80px;"></div>
                  <div class="skeleton-item" style="height: 1rem; width: 60px;"></div>
                </div>
                <div class="info-item">
                  <div class="skeleton-item" style="height: 1rem; width: 70px;"></div>
                  <div class="skeleton-item" style="height: 1rem; width: 80px;"></div>
                </div>
                <div class="info-item">
                  <div class="skeleton-item" style="height: 1rem; width: 75px;"></div>
                  <div class="skeleton-item" style="height: 1rem; width: 50px;"></div>
                </div>
                <div class="info-item">
                  <div class="skeleton-item" style="height: 1rem; width: 60px;"></div>
                  <div class="skeleton-item" style="height: 1rem; width: 70px;"></div>
                </div>
              </div>
            </div>

            <!-- Company Details Card Skeleton -->
            <div class="sidebar-card skeleton">
              <div class="card-header">
                <div class="skeleton-item" style="height: 1.5rem; width: 140px;"></div>
              </div>
              <div class="card-body">
                <div class="company-info">
                  <div class="company-logo skeleton-item"></div>
                  <div class="company-details">
                    <div class="skeleton-item" style="height: 1.2rem; width: 100px; margin-bottom: 0.5rem;"></div>
                    <div class="skeleton-item" style="height: 1rem; width: 120px; margin-bottom: 0.75rem;"></div>
                    <div class="skeleton-item" style="height: 1rem; width: 90px;"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Action Buttons Skeleton -->
            <div class="action-buttons">
              <div class="skeleton-item" style="height: 3rem; width: 100%; border-radius: 10px; margin-bottom: 1rem;">
              </div>
              <div class="skeleton-item" style="height: 3rem; width: 100%; border-radius: 10px;"></div>
            </div>

          </aside>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="!isLoading && errorMsg">
      <div class="error-container">
        <p class="text-danger">{{ errorMsg }}</p>
      </div>
    </ng-container>

    <ng-container *ngIf="!isLoading && job">
      <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
          <div class="job-content-card">

            <!-- Overview Section -->
            <section class="content-section">
              <header class="section-header">
                <div class="section-icon">
                  <i class="fas fa-eye"></i>
                </div>
                <h3>Overview</h3>
              </header>
              <div class="section-content">
                <p class="overview-text">
                  {{ job.overview ? job.overview : 'No overview available for this job.' }}
                </p>
                <div class="job-meta-tags">
                  <span class="meta-tag">{{ job.job_location }}</span>
                  <span class="meta-tag">{{ job.employment_type }}</span>
                  <span class="meta-tag">{{ job.salary_amount | currency: job.currency :'symbol-narrow':'1.0-0'
                    }}</span>
                </div>
              </div>
            </section>

            <!-- Job Description Section -->
            <section class="content-section">
              <header class="section-header">
                <div class="section-icon">
                  <i class="fas fa-file-alt"></i>
                </div>
                <h3>Job Description</h3>
              </header>
              <div class="section-content" *ngIf="job.description; else noDescription">
                <div class="description-content" [class.expanded]="showFullDescription">
                  <p>{{ job.description }}</p>
                </div>
                <button class="show-more-btn" *ngIf="job.description && job.description.length > 200"
                  (click)="toggleDescription()">
                  {{ showFullDescription ? 'Show Less' : 'Show More' }}
                </button>
              </div>

              <ng-template #noDescription>
                <p>No description available for this job.</p>
              </ng-template>
            </section>

            <!-- Responsibilities Section -->
            <section class="content-section">
              <header class="section-header">
                <div class="section-icon">
                  <i class="fas fa-tasks"></i>
                </div>
                <h3>Responsibilities</h3>
              </header>
              <div class="section-content">
                <ng-container *ngIf="job.responsibilities && job.responsibilities.length > 0; else noResponsibilities">
                  <ul>
                    <li *ngFor="let responsibility of job.responsibilities.split('\n')">
                      {{ responsibility }}
                    </li>
                  </ul>
                </ng-container>
                <ng-template #noResponsibilities>
                  No specific responsibilities listed for this job.
                </ng-template>
              </div>
            </section>

            <!-- Required Skills Section -->
            <section class="content-section">
              <header class="section-header">
                <div class="section-icon">
                  <i class="fas fa-check-circle"></i>
                </div>
                <h3>Required Skills</h3>
              </header>
              <div class="section-content">
                <ng-container *ngIf="job.requirements && job.requirements.length > 0; else defaultSkills">
                  <ul class="skills-list">
                    <li *ngFor="let skill of processedRequirements">
                      {{ skill }}
                    </li>
                  </ul>
                </ng-container>
                <ng-template #defaultSkills>
                  No specific skills listed for this job.
                </ng-template>
              </div>
            </section>

            <!-- Nice to Have Section -->
            <section class="content-section">
              <header class="section-header">
                <div class="section-icon">
                  <i class="fas fa-star"></i>
                </div>
                <h3>Nice to Have</h3>
              </header>
              <div class="section-content">
                <ng-container *ngIf="job.nice_to_have && job.nice_to_have.trim().length > 0; else noNiceToHave">
                  <ul class="benefits-list">
                    <li *ngFor="let item of job.nice_to_have.split('\n')">
                      {{ item.trim() }}
                    </li>
                  </ul>
                </ng-container>
                <ng-template #noNiceToHave>
                  No nice to have skills listed for this job.
                </ng-template>
              </div>
            </section>

            <!-- Benefits Section -->
            <section class="content-section">
              <header class="section-header">
                <div class="section-icon">
                  <i class="fas fa-gift"></i>
                </div>
                <h3>Benefits</h3>
              </header>
              <div class="section-content">
                <ng-container *ngIf="job.benefits && job.benefits.trim().length > 0; else noBenefits">
                  <ul class="benefits-list">
                    <li *ngFor="let benefit of job.benefits.split('\n')">
                      {{ benefit.trim() }}
                    </li>
                  </ul>
                </ng-container>
                <ng-template #noBenefits>
                  No benefits listed for this job.
                </ng-template>
              </div>
            </section>

          </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
          <aside class="job-sidebar">

            <!-- Job Summary Card -->
            <div class="sidebar-card">
              <div class="card-header">
                <h4>Job Summary</h4>
              </div>
              <div class="card-body">
                <div class="info-item">
                  <strong>Published:</strong>
                  <span>{{ job.published_at | relativeTime }}</span>
                </div>
                <div class="info-item">
                  <strong>Location:</strong>
                  <span>{{ job.job_location }}</span>
                </div>
                <div class="info-item">
                  <strong>Job Type:</strong>
                  <span>{{ job.employment_type | capitalizeFirst }}</span>
                </div>
                <div class="info-item">
                  <strong>Salary:</strong>
                  <span>{{ job.salary_amount | currency: job.currency :'symbol-narrow':'1.0-0' }}</span>
                </div>
              </div>
            </div>

            <!-- Company Details Card -->
            <div class="sidebar-card">
              <div class="card-header">
                <h4>Company Details</h4>
              </div>
              <div class="card-body">
                <div class="company-info">
                  <div class="company-logo">
                    <!-- <i class="fas fa-building"></i> -->
                    <img [src]="job.logo_url" loading="lazy" alt="Company Logo"
                      style="width: 50px; height: 50px; object-fit: cover;" />
                  </div>
                  <div class="company-details">
                    <h5>{{ job.company_name || 'Company Name' }}</h5>
                    <p>{{ job.company_location }}</p>
                    <a [href]="job.website" class="company-website" target="_blank" rel="noopener noreferrer">Visit Website</a>
                  </div>
                </div>
              </div>
            </div>

                        <!-- Closed Job Alert -->
            <div class="alert alert-danger fade-in" *ngIf="job?.is_closed" role="alert">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>This job is closed.</strong> Applications are no longer being accepted.
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
              <button class="btn btn-apply btn-block mb-2" *ngIf="!userRole || userRole === 'job_seeker'"
                [disabled]="hasApplied || isRetracted || isApplying || job?.is_closed" (click)="onApplyNow()">
                <div class="btn-content">
                  <div class="spinner-border spinner-border-sm me-2" *ngIf="isApplying"></div>
                  <i class="fas fa-paper-plane me-2" *ngIf="!isApplying && !isRetracted && !job?.is_closed"></i>
                  <i class="fas fa-ban me-2" *ngIf="!isApplying && (isRetracted || job?.is_closed)"></i>
                  <span *ngIf="isApplying">Applying...</span>
                  <span *ngIf="!isApplying">
                    {{ isRetracted ? 'Application Retracted' : job?.is_closed ? 'Job Closed' : hasApplied ? 'Already Applied' : 'Apply for this position' }}
                  </span>
                </div>
              </button>

              <!-- Save button remains enabled for closed jobs, as users might want to save for reference -->
              <button class="btn btn-save btn-block" [class.active]="job.isSaved"
                [class.loading]="job.isSaving" [disabled]="job.isSaving" (click)="onToggleSaveJob()"
                *ngIf="!userRole || userRole === 'job_seeker'">
                <div class="btn-content">
                  <div class="spinner-border spinner-border-sm me-2" *ngIf="job.isSaving"></div>
                  <i *ngIf="!job.isSaving && !job.isSaved" class="far fa-bookmark me-2"></i>
                  <i *ngIf="!job.isSaving && job.isSaved" class="fas fa-bookmark bookmark-saved me-2"></i>
                  <span *ngIf="job.isSaving && !job.isSaved">Saving...</span>
                  <span *ngIf="job.isSaving && job.isSaved">Unsaving...</span>
                  <span *ngIf="!job.isSaving">
                    {{ job.isSaved ? 'Unsave' : 'Save Job' }}
                  </span>
                </div>
              </button>
            </div>

          </aside>
        </div>
      </div>
    </ng-container>
  </div>

  <!-- Related Jobs Section -->
  <section class="related-jobs-section" *ngIf="!isLoading && job">
    <div class="container">
      <div class="related-jobs-header">
        <h2 class="section-title">Related Jobs</h2>

        <!-- DESKTOP NAV BUTTONS (768px and up) -->
        <div class="swiper-nav-buttons desktop-nav">
          <div class="swiper-button-prev"></div>
          <div class="swiper-button-next"></div>
        </div>
      </div>

      <!-- SWIPER CONTAINER -->
      <swiper-container #relatedSwiper class="related-jobs-swiper" pagination="false"
        navigation="true" navigation-next-el=".swiper-button-next" navigation-prev-el=".swiper-button-prev"
        autoplay='{"delay": 3000, "disableOnInteraction": true}' breakpoints='{
        "0": { "slidesPerView": 1, "spaceBetween": 20 },
        "768": { "slidesPerView": 2, "spaceBetween": 20 },
        "992": { "slidesPerView": 3, "spaceBetween": 30 }
      }'>
        <swiper-slide *ngFor="let relatedJob of relatedJobs">
          <div class="related-job-card">
            <div class="job-card-header">
              <h4 class="job-card-title">{{ relatedJob.job_title }}</h4>
              <span class="job-type-badge">{{ relatedJob.job_type }}</span>
            </div>
            <div class="job-card-body">
              <p class="company-name">{{ relatedJob.company_name }}</p>
              <p class="job-location">{{ relatedJob.location }}</p>
              <p class="job-salary">â‚¦{{ relatedJob.salary }}</p>
            </div>
            <div class="job-card-footer">
              <a [routerLink]="['/jobdetails', relatedJob.job_id]" class="btn btn-outline-primary btn-sm">
                View Details
              </a>
            </div>
          </div>
        </swiper-slide>
      </swiper-container>

      <!-- MOBILE NAV BUTTONS (below swiper on small screens) -->
      <div class="swiper-nav-buttons mobile-nav">
        <div class="swiper-button-prev"></div>
        <div class="swiper-button-next"></div>
      </div>
    </div>
  </section>

  <!-- Apply Modal -->
  <div class="modal-overlay" [class.active]="showApplyModal" (click)="closeApplyModal()" role="dialog" aria-modal="true" aria-labelledby="applyModalTitle">
    <div class="modal-content apply-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 id="applyModalTitle">Apply for {{ job?.title }}</h3>
        <button class="modal-close-btn" (click)="closeApplyModal()" aria-label="Close dialog">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form (ngSubmit)="submitApplication()" enctype="multipart/form-data">
        <div class="modal-body">
          <div class="form-group">
            <label for="coverLetter">Cover Letter (Optional)</label>
            <textarea
              id="coverLetter"
              [(ngModel)]="coverLetter"
              name="coverLetter"
              placeholder="Tell us why you're interested in this position..."
              rows="4"
              maxlength="500"
              class="form-control">
            </textarea>
            <small class="text-muted">{{ coverLetter.length }}/500 characters</small>
          </div>

          <div class="form-group">
            <label for="cvFile">Upload CV (Optional)</label>
            <input
              type="file"
              id="cvFile"
              (change)="onFileSelected($event)"
              accept=".pdf,.docx"
              class="form-control" />
            <small class="text-muted">
              Accepted formats: PDF, DOCX (Max 10MB).
              {{ selectedFileName ? 'Selected: ' + selectedFileName : (hasDefaultCV ? 'If not uploaded, your default CV will be used.' : 'No default CV found. Upload one to apply.') }}
            </small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeApplyModal()" [disabled]="isApplying">Cancel</button>
          <button type="submit" class="btn btn-apply" [disabled]="isApplying || (!selectedFile && !hasDefaultCV)">
            <span *ngIf="isApplying" class="spinner-border spinner-border-sm me-2"></span>
            {{ isApplying ? 'Applying...' : 'Submit Application' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- CTA only for unauthenticated users -->
  <app-cta *ngIf="!isLoggedIn()"></app-cta>
  <app-footer></app-footer>
</div>